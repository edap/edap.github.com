<!doctype html>
<html lang="en">

    <head>
    <meta charset="utf-8">
    <title>Be the sun</title>
    <meta name="description" content="A once in a life-time occasion to be the sun, making sunsets and sunrises whenever you want">
    <meta name="author" content="Davide Prati">
    <script src="js/headtrackr.js"></script>
    <script src="js/regl.min.js"></script>
    </head>

    <body style="margin: 0px; padding: 0px; overflow: hidden;">
    <canvas id="inputCanvas" style="display:none; top:0px"></canvas>
    <canvas id="canvasWebGL" width="1000" height="1000"></canvas>
    <video id="inputVideo" autoplay loop style="display:none; top:0px"></video>

    <script type="text/javascript">
    var videoInput = document.getElementById('inputVideo');
    var canvasInput = document.getElementById('inputCanvas');
    var canvasWebGL = document.getElementById('canvasWebGL');
    canvasWebGL.width = window.innerWidth;
    canvasWebGL.height = window.innerHeight;

    var htracker = new headtrackr.Tracker({ui:true});
    htracker.init(videoInput, canvasInput);
    htracker.start();
    var headPosition = [0.0,0.0];
    var sunSize = 0.05;

    function map_range(value, low1, high1, low2, high2) {
         var mapped =  low2 + (high2 - low2) * (value - low1) / (high1 - low1);
         return Math.min(Math.max(mapped, low2), high2);
    }

    document.addEventListener('headtrackrStatus',
        function (event) {
            if (event.status == "getUserMedia") {
                console.log("getUserMedia is supported!");
            }
        }
    );

    document.addEventListener('headtrackingEvent',
        function (event) {
            if (event) {
                var x = map_range(event.x, -7, 7, 0, canvasWebGL.width);
                var y = map_range(event.y, 0, 12, 0, canvasWebGL.height);
                var z = map_range(event.z, 80, 25, 0, 0.7);
                headPosition[0] = x;
                headPosition[1] = y;
                sunSize = z;
            }
        }
    );

    var regl = createREGL({
         canvas: canvasWebGL
    });

    const drawTriangle = regl({
        frag: `
        precision mediump float;
        uniform float uSunSize;
        uniform vec2 iResolution;
        uniform vec2 uHead;

        float circleSmooth(in vec2 st, in vec2 pos, in float begin, in float end) {
            float pct = 0.0;
            pct = 1. - smoothstep(begin, end, distance(st, pos));
            return pct;
        }

        float rectangleGradientBottom(in vec2 st, in vec2 origin, in vec2 dimensions, float smoothness) {
            vec2 center = step(origin, st); // it is actually the bottom left cornter
            float pct = center.x * center.y;
            vec2 full = step(1.0 - origin - dimensions, 1.0 - st);
            float height = origin.y+dimensions.y;
            pct *= full.x * full.y;
            pct *= smoothstep(height, origin.y+smoothness,st.y);
            return pct;
        }

        //  Function from IÃ±igo Quiles
        //  www.iquilezles.org/www/articles/functions/functions.htm
        float parabola( float x, float k ){
            return pow( 4.0*x*(1.0-x), k );
        }

        void main() {
            vec2 uv = gl_FragCoord.xy / iResolution.xy;
            vec2 headNorm = uHead/iResolution;
            vec2 m = vec2(headNorm.x, parabola(headNorm.x, 1.2));
            vec3 color = vec3(0.1, 0.4, 0.9);
            color += vec3(0.9-m.y,0.6-uv.y, -(1.0-m.y));
            uv.x *= iResolution.x / iResolution.y;
            m.x *= iResolution.x / iResolution.y;
            vec2 recPos = vec2(0.0, 0.0);

            // kind of sun, with a lot of imagination
            color.rg += circleSmooth(uv, vec2(m), 0.05, 0.15 + uSunSize);
            float turnOffSky = smoothstep(0.25, 0.27,m.y);
            color*= turnOffSky;

            // earth
            vec3 earth = vec3(vec2(rectangleGradientBottom(uv, recPos, vec2(2.0, 0.3), 0.16)), 0.0);
            earth.r += 1.0 -m.y;
            color += earth;
            float turnOffEarth = smoothstep(0.09, 0.25,m.y);
            color*= turnOffEarth;

            gl_FragColor = vec4(color, 1.0);
        }`,

        vert: `
        precision mediump float;
        attribute vec3 position;

        void main() {
            gl_Position = vec4(position, 1);
        }`,

        attributes: {
            position: regl.buffer([
                [[-1, -1, 0], [-1, 1, 0], [1, 1, 0]],
                [[1, 1, 0], [1, -1, 0], [-1, -1, 0]]
            ])
        },

        uniforms: {
            iResolution:regl.prop('resolution'),
            uSunSize:regl.prop('sunSize'),
            //iTime:regl.prop('time'),
            uHead:regl.prop('headPosition')
        },
        count: 6
    })

    regl.frame(function (context) {
        drawTriangle({
            resolution: [context.viewportWidth,context.viewportHeight],
            sunSize: sunSize,
            headPosition: headPosition
        })


    })
    </script>
    </body>
</html>
