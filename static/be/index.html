<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Be the sun</title>
    <meta name="description"
        content="A once in a life-time occasion to be the sun, making sunsets and sunrises whenever you want">
    <meta name="author" content="Davide Prati">
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh"></script> -->
    <script src="./js/regl.min.js"></script>
    <script src="./js/tf.js"></script>
	<script src="./js/facemesh.js"></script>

<script>
async function setupCamera() {
  video = document.getElementById('video');
  const stream = await navigator.mediaDevices.getUserMedia({
    'audio': false,
    'video': {
      facingMode: 'user',
    //   width: {ideal:1920},
    //   height: {ideal:1080},
      width: {ideal:740},
      height: {ideal:420},
    },
  });
  video.srcObject = stream;

  return new Promise((resolve) => {
    video.onloadedmetadata = () => {
      resolve(video);
    };
  });
}

// Calls face mesh on the video and outputs the eyes and face bounding boxes to global vars
var curFaces = [];
async function renderPrediction() {
    const facepred = await fmesh.estimateFaces(video);

    if (facepred.length > 0) { // If we find a face, process it
      curFaces = facepred;
    }

  requestAnimationFrame(renderPrediction);
};

function drawVideo(){
  ctx.drawImage(video, 0, 0);
  for (face of curFaces){
    if (face.faceInViewConfidence > .95) {
      drawFace(face);  
    }
  } 
  requestAnimationFrame(drawVideo);
}

// Draws the current eyes onto the canvas, directly from video streams
async function drawFace(face){
   let i = 0;
   ctx.fillStyle = 'cyan';
   ctx.font = "10px Arial";
    for (pt of face.scaledMesh){
      ctx.beginPath();
      ctx.ellipse(pt[0], pt[1], 3,3, 0, 0, 2*Math.PI)
      ctx.fill();

      ctx.strokeText(i, pt[0], pt[1]);
      i = i+1;
    }
}


let canvas;
let ctx;
let fmesh;
async function main() {
    fmesh = await facemesh.load({maxFaces:3});

    // Set up front-facing camera
    await setupCamera();
    let videoWidth = video.videoWidth;
    let videoHeight = video.videoHeight;
    video.play()

    // HTML Canvas for the video feed
    canvas = document.getElementById('facecanvas');
    canvas.width = videoWidth;
    canvas.height = videoHeight;

    // let regl = createREGL({
    //         canvas: canvas
    // });
    ctx = canvas.getContext('2d');

    drawVideo()
    renderPrediction();
}


main();
</script>


</head>

<body style="margin: 0px; padding: 0px; overflow: hidden;">

    <video autoplay muted 
        playsinline hidden id="video"
        style="width: auto; height: auto;">
	</video>
    <canvas id="facecanvas"></canvas>
</body>

</html>